# 🧪 性能修复测试清单

## 📋 测试前准备

### 1. 编译应用
```powershell
flutter clean
flutter pub get
flutter build windows --release
```

### 2. 启动后端服务
确保后端服务运行在 `http://localhost:8080`

---

## ✅ 功能测试

### 测试 1: Timer 管理器基础功能
**目标**: 验证 TimerManager 正常工作

**步骤**:
1. 启动应用
2. 打开实时大屏页面
3. 检查日志：应该看到 `Timer [realtime_dashboard_polling] 已注册`
4. 切换到历史数据页面
5. 检查日志：应该看到 `Timer [realtime_dashboard_polling] 已暂停`
6. 切换回实时大屏
7. 检查日志：应该看到 `Timer [realtime_dashboard_polling] 已恢复`

**预期结果**: ✅ Timer 正确暂停和恢复

---

### 测试 2: 页面切换时 Timer 控制
**目标**: 验证隐藏页面不会继续轮询

**步骤**:
1. 启动应用（默认在实时大屏）
2. 等待 10 秒，观察网络请求
3. 切换到历史数据页面
4. 等待 10 秒，观察网络请求
5. 切换到状态监控页面
6. 等待 10 秒，观察网络请求

**预期结果**: 
- ✅ 实时大屏：每 5 秒发送 3 个请求（hopper/roller/scr）
- ✅ 历史数据：不发送轮询请求（按需查询）
- ✅ 状态监控：每 5 秒发送 1 个请求（status）

**验证方法**:
- 查看日志中的网络请求记录
- 或使用 Wireshark 抓包

---

### 测试 3: `_isRefreshing` 卡死保护
**目标**: 验证网络超时后自动恢复

**步骤**:
1. 启动应用
2. **关闭后端服务**（模拟网络异常）
3. 等待 20 秒
4. 检查日志：应该看到 `_isRefreshing 卡死超过 15s，强制重置！`
5. **重启后端服务**
6. 等待 10 秒
7. 检查 UI：数据应该恢复刷新

**预期结果**: ✅ 卡死后自动恢复，数据继续刷新

---

### 测试 4: 网络异常退避策略
**目标**: 验证连续失败后自动延长轮询间隔

**步骤**:
1. 启动应用
2. **关闭后端服务**
3. 观察日志中的轮询间隔变化

**预期结果**:
```
第 1 次失败: 轮询间隔延长至 10s
第 2 次失败: 轮询间隔延长至 20s
第 3 次失败: 轮询间隔延长至 40s
第 4 次失败: 轮询间隔延长至 60s
```

**验证**: ✅ 日志中看到 `网络异常，轮询间隔延长至 Xs`

---

### 测试 5: 资源清理
**目标**: 验证应用退出时所有 Timer 被取消

**步骤**:
1. 启动应用
2. 切换到实时大屏
3. 切换到状态监控
4. 关闭应用
5. 检查日志：应该看到 `TimerManager 正在关闭，取消所有 Timer...`

**预期结果**: ✅ 所有 Timer 被正确取消

---

## 🚀 性能测试

### 测试 6: CPU 占用率
**目标**: 验证 CPU 占用率降低

**步骤**:
1. 启动应用
2. 打开任务管理器
3. 记录 CPU 占用率（运行 5 分钟后的平均值）

**预期结果**:
- ✅ 修复前: ~15-20%
- ✅ 修复后: ~5-8%（降低 60%）

---

### 测试 7: 内存占用
**目标**: 验证无内存泄漏

**步骤**:
1. 启动应用
2. 打开任务管理器
3. 记录初始内存占用
4. 运行 1 小时
5. 记录最终内存占用

**预期结果**:
- ✅ 初始: ~150 MB
- ✅ 1 小时后: ~150-180 MB（增长 < 20%）
- ✅ 无持续增长趋势

---

### 测试 8: 网络请求数量
**目标**: 验证网络请求减少

**步骤**:
1. 启动应用（实时大屏）
2. 运行 1 分钟
3. 统计网络请求数量

**预期结果**:
- ✅ 修复前: ~180 个请求/分钟（3 页面 × 3 请求 × 12 次）
- ✅ 修复后: ~36 个请求/分钟（1 页面 × 3 请求 × 12 次）
- ✅ 减少 80%

---

## 🔍 稳定性测试

### 测试 9: 长时间运行
**目标**: 验证 24 小时稳定运行

**步骤**:
1. 启动应用
2. 运行 24 小时
3. 每 4 小时检查一次：
   - UI 是否正常刷新
   - 内存占用是否稳定
   - 日志中是否有异常

**预期结果**:
- ✅ UI 持续刷新
- ✅ 内存占用稳定（< 200 MB）
- ✅ 无卡死现象
- ✅ 无崩溃

---

### 测试 10: 网络抖动
**目标**: 验证网络不稳定时的容错能力

**步骤**:
1. 启动应用
2. 每隔 30 秒关闭/重启后端服务（模拟网络抖动）
3. 持续 10 分钟
4. 观察应用行为

**预期结果**:
- ✅ 应用不崩溃
- ✅ 网络恢复后自动恢复数据刷新
- ✅ 退避策略正常工作
- ✅ UI 保持响应

---

### 测试 11: 快速切换页面
**目标**: 验证快速切换页面时无异常

**步骤**:
1. 启动应用
2. 快速切换页面（每秒切换一次）
3. 持续 1 分钟
4. 检查日志和 UI

**预期结果**:
- ✅ 无崩溃
- ✅ 无 Timer 泄漏
- ✅ UI 正常显示
- ✅ 日志中无异常

---

## 📊 诊断工具测试

### 测试 12: Timer 状态诊断
**目标**: 验证诊断工具正常工作

**步骤**:
1. 在代码中添加诊断调用：
```dart
// 在 RealtimeDashboardPage 的 _fetchData 中添加
if (_successCount % 10 == 0) {
  TimerManager().diagnose();
  final status = TimerManager().getTimerStatus();
  logger.info('Timer 状态: $status');
}
```
2. 运行应用
3. 检查日志输出

**预期结果**: ✅ 日志中显示所有 Timer 的状态信息

---

## ✅ 测试结果记录

### 功能测试
- [ ] 测试 1: Timer 管理器基础功能
- [ ] 测试 2: 页面切换时 Timer 控制
- [ ] 测试 3: `_isRefreshing` 卡死保护
- [ ] 测试 4: 网络异常退避策略
- [ ] 测试 5: 资源清理

### 性能测试
- [ ] 测试 6: CPU 占用率
- [ ] 测试 7: 内存占用
- [ ] 测试 8: 网络请求数量

### 稳定性测试
- [ ] 测试 9: 长时间运行（24 小时）
- [ ] 测试 10: 网络抖动
- [ ] 测试 11: 快速切换页面

### 诊断工具测试
- [ ] 测试 12: Timer 状态诊断

---

## 🐛 问题记录

如果测试中发现问题，请记录：

### 问题 1
- **测试项**: 
- **现象**: 
- **日志**: 
- **复现步骤**: 

### 问题 2
- **测试项**: 
- **现象**: 
- **日志**: 
- **复现步骤**: 

---

## 📝 测试总结

### 通过的测试
- 

### 失败的测试
- 

### 性能改进
- CPU 占用率: 修复前 __% → 修复后 __%
- 内存占用: 修复前 __ MB → 修复后 __ MB
- 网络请求: 修复前 __ 个/分钟 → 修复后 __ 个/分钟

### 建议
- 

---

**测试日期**: ____________  
**测试人员**: ____________  
**测试环境**: Windows 10/11, Flutter 版本 ______

