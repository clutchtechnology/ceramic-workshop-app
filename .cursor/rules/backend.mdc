# 陶瓷电炉后端 API 开发规范

> **项目标识**: `ceramic-electric-furnace-backend` (FastAPI + InfluxDB + S7-1200)
> **语言**: 中文回答
> **模型**: GPT-5.2

---

## 1. 项目定义

```yaml
项目名称: ceramic-electric-furnace-backend
应用类型: 工业物联网后端 API
技术栈: Python 3.11+ / FastAPI / python-snap7
数据库: InfluxDB 2.7 (时序数据)
通信协议: Siemens S7-1200 PLC
部署方式: 工控机本地 (Python venv, 非 Docker)
端口: 8082 (API) / 8089 (InfluxDB)
```

---

## 2. 核心架构原则

| 原则 | 说明 |
|------|------|
| **数据与状态分离** | Data (DB32) → InfluxDB 存储；Status (DB30) → 内存缓存 |
| **模块化配置** | 基础模块定义在 `configs/plc_modules.yaml`，通过 `module_ref` 引用 |
| **PLC 长连接** | 工控机部署，使用 `python-snap7` 单例连接管理器 |
| **批量操作** | InfluxDB 批量写入，减少 I/O 开销 |

---

## 3. 项目结构

```
ceramic-electric-furnace-backend/
├── main.py                    # FastAPI 入口
├── config.py                  # 全局配置 (pydantic-settings)
├── requirements.txt           # Python 依赖
├── configs/                   # [核心配置目录]
│   ├── plc_modules.yaml       # 基础模块定义
│   ├── config_L3_P2_F2_C4.yaml   # DB32 数据配置
│   ├── status_L3_P2_F2_C4.yaml   # DB30 状态配置
│   └── db_mappings.yaml       # DB 块映射
├── app/
│   ├── plc/                   # PLC 通信层
│   │   ├── plc_manager.py     # 单例连接管理器
│   │   ├── parser_modbus.py   # DB32 解析器
│   │   └── parser_status.py   # DB30 解析器
│   ├── services/              # 业务逻辑层
│   │   ├── polling_service.py # 轮询核心服务
│   │   └── furnace_service.py # 业务查询服务
│   ├── tools/                 # 数据转换工具
│   │   └── converter_*.py     # 原始值 → 物理量
│   ├── routers/               # API 路由层
│   │   ├── furnace.py         # 业务接口
│   │   └── monitor.py         # 监控接口
│   └── core/                  # 核心工具
│       ├── influxdb.py        # InfluxDB 客户端
│       └── cache.py           # 内存缓存
└── tests/                     # 测试目录
```

---

## 4. 数据流架构

```
S7-1200 PLC (192.168.1.10)
    ↓ (DB32 数据 / DB30 状态)
PLCManager (单例长连接)
    ↓
Parser (解析器)
    ↓
├─ Data Buffer → InfluxDB (批量写入, 30条/批)
└─ Memory Cache → FastAPI API (实时查询)
```

---

## 5. 配置系统

### 5.1 基础模块定义 (`configs/plc_modules.yaml`)

```yaml
modules:
  InfraredDistance:
    size: 4
    fields:
      - {name: HIGH, type: WORD, offset: 0}
      - {name: LOW, type: WORD, offset: 2}
  
  PowerMeter:
    size: 12
    fields:
      - {name: Pt, type: REAL, offset: 0}
      - {name: ImpEp, type: REAL, offset: 4}
      - {name: Ua_0, type: REAL, offset: 8}
```

### 5.2 实例化配置 (`configs/config_L3_P2_F2_C4.yaml`)

```yaml
db_number: 32
modules:
  - name: LENTH_1
    module_ref: InfraredDistance
    offset: 0
  
  - name: METER_1
    module_ref: PowerMeter
    offset: 4
```

### 5.3 配置引用规则

- **不要硬编码偏移量**: 所有偏移量从配置文件读取
- **模块复用**: 相同类型设备引用同一 `module_ref`
- **特殊处理**: DB32 偏移量 28 (MBrly) 是写寄存器，解析时跳过

---

## 6. 代码规范

### 6.1 文件头注释 (必须)

```python
# ============================================================
# 文件说明: polling_service.py - PLC 数据轮询服务
# ============================================================
# 方法列表:
# 1. start_polling()    - 启动轮询任务
# 2. stop_polling()     - 停止轮询任务
# 3. _poll_cycle()      - 单次轮询周期
# ============================================================
```

### 6.2 方法注释 (必须)

```python
# ---
# 1. start_polling() - 启动轮询任务
# ---
async def start_polling(self):
    """启动 PLC 数据轮询任务"""
    if self._polling_task is None:
        self._polling_task = asyncio.create_task(self._poll_loop())
```

### 6.3 精简原则

- **不要**: 未使用的代码、过度封装、提前优化
- **要做**: 直接实现业务、代码自文档化、必要时才抽象
- **函数**: 单一职责，≤50行
- **类**: 仅在需要状态管理时使用

---

## 7. PLC 通信规范

### 7.1 S7-1200 连接参数

```python
IP: 192.168.1.10
Rack: 0  # S7-1200 固定
Slot: 1  # S7-1200 固定
Timeout: 5000ms
Poll_Interval: 6s
```

### 7.2 数据类型 (Big Endian)

```python
import snap7.util as s7util

# REAL (32-bit float)
value = s7util.get_real(data, offset)

# INT (16-bit signed)
value = s7util.get_int(data, offset)

# DINT (32-bit signed)
value = s7util.get_dint(data, offset)

# WORD (16-bit unsigned)
value = s7util.get_word(data, offset)

# BOOL
value = s7util.get_bool(data, byte_offset, bit_offset)
```

### 7.3 批量读取 (推荐)

```python
# 一次读取整个 DB 块，减少通信开销
data = client.db_read(db_number, start=0, size=100)
```

### 7.4 单例管理器

```python
from app.plc.plc_manager import get_plc_manager

# 获取全局单例
plc_manager = get_plc_manager()

# 读取 DB 块
data = plc_manager.read_db(db_number=32, start=0, size=100)
```

---

## 8. InfluxDB 规范

### 8.1 Measurement 设计

```python
measurement: "furnace_sensor_data"
tags: {
    "device_id": "F1",
    "sensor_type": "temperature",
    "zone": "Z1"
}
fields: {
    "temperature": 850.5,
    "voltage": 380.2,
    "current": 15.3,
    "power": 5845.0
}
```

### 8.2 批量写入

```python
# 配置
BATCH_SIZE = 30  # 多少次轮询后批量写入

# 实现
buffer = []
for data in polling_results:
    buffer.append(data)
    if len(buffer) >= BATCH_SIZE:
        influx_client.write_points_batch(buffer)
        buffer.clear()
```

### 8.3 数据保留策略

```
realtime: 7天 (原始数据)
hourly: 90天 (聚合)
daily: 2年 (聚合)
```

---

## 9. API 设计规范

### 9.1 端点设计

```http
# 实时监控
GET /api/monitor/realtime       # DB32 解析后的物理量
GET /api/monitor/status         # DB30 解析后的通信状态

# 历史数据
GET /api/furnace/history        # InfluxDB 历史趋势
  ?start=2026-01-01T00:00:00Z
  &end=2026-01-24T23:59:59Z
  &device_id=F1

# 系统健康
GET /api/health                 # 整体健康检查
GET /api/health/plc             # PLC 连接状态
GET /api/health/database        # InfluxDB 连接状态

# 配置管理
GET /api/config/plc             # 获取 PLC 配置
PUT /api/config/plc             # 更新 PLC 配置
POST /api/config/plc/test       # 测试 PLC 连接
```

### 9.2 响应格式

```python
# 成功
{
    "success": True,
    "data": {...}
}

# 失败
{
    "success": False,
    "error": "PLC connection timeout"
}

# 分页
{
    "success": True,
    "data": [...],
    "pagination": {
        "page": 1,
        "page_size": 50,
        "total": 1000
    }
}
```

---

## 10. 轮询服务规范

### 10.1 核心逻辑 (`polling_service.py`)

```python
# 1. 单例管理: 从 plc_manager 获取连接
# 2. 异常隔离: 解析错误不中断轮询循环
# 3. 特殊处理: DB32 偏移量 28 (MBrly) 跳过
# 4. 批量写入: InfluxDB 使用 write_points_batch
```

### 10.2 错误处理

```python
try:
    data = plc_manager.read_db(32, 0, 100)
    parsed = parser.parse(data)
except PLCConnectionError as e:
    logger.error(f"PLC 连接失败: {e}")
    # 不中断轮询，等待下次重试
except ParseError as e:
    logger.warning(f"数据解析失败: {e}")
    # 记录错误，继续轮询
```

---

## 11. 开发环境

### 11.1 开发机配置

```powershell
# 目录
PS C:\Users\20216\Documents\GitHub\Clutch\ceramic-electric-furnace-backend>

# 创建虚拟环境
python -m venv venv
.\venv\Scripts\Activate.ps1

# 安装依赖
pip install -r requirements.txt

# 启动 InfluxDB (本地测试)
# 方式 1: Docker
docker run -d -p 8089:8086 --name influxdb influxdb:2.7

# 方式 2: 本地安装
# 下载 InfluxDB 2.7 Windows 版本并启动

# 启动后端
python main.py
```

### 11.2 环境变量

```bash
# 服务器
SERVER_PORT=8082
DEBUG=true
ENABLE_POLLING=true

# PLC
PLC_IP=192.168.1.10
PLC_RACK=0
PLC_SLOT=1

# InfluxDB
INFLUX_URL=http://localhost:8089
INFLUX_TOKEN=furnace-token
INFLUX_ORG=furnace
INFLUX_BUCKET=sensor_data
```

---

## 12. 工控机部署

### 12.1 部署目录

```
D:\furnace-backend\       # 运行目录
├── venv\                 # Python 虚拟环境
├── configs\              # 配置文件
├── app\                  # 应用代码
├── main.py               # 入口文件
└── requirements.txt      # 依赖清单
```

### 12.2 部署命令

```powershell
# 解压部署包
Expand-Archive -Path "furnace-backend-1.1.8.zip" -DestinationPath "D:\furnace-backend" -Force

# 启动服务
cd D:\furnace-backend
.\venv\Scripts\python.exe main.py
```

### 12.3 看门狗脚本

```powershell
# 检查后端进程
$Backend = Get-WmiObject Win32_Process -Filter "name='python.exe'" | Where-Object { $_.CommandLine -like "*main.py*" }

if (-not $Backend) {
    Start-Process powershell.exe -ArgumentList '-NoExit', '-Command', 'cd D:\furnace-backend; .\venv\Scripts\python.exe main.py' -WindowStyle Hidden
}
```

---

## 13. 常见问题

| 问题 | 解决方案 |
|-----|---|
| PLC 连接失败 | 检查 IP, Rack=0, Slot=1 |
| 数据解析错误 | 确保 Big Endian 字节序 |
| InfluxDB 写入慢 | 启用批量写入 (BATCH_SIZE=30) |
| Address out of range | DB块不存在或大小不足 |
| 端口被占用 | 检查 8082/8089 端口占用情况 |

---

## 14. AI 开发指令

### 14.1 代码生成规则

1. **配置优先**: 优先参考 `configs/` 目录定义，不要硬编码偏移量
2. **工控机模式**: 不考虑 Mock 模式，直接连接真实 PLC
3. **测试脚本**: 提供可直接在工控机运行的命令行，不创建本地脚本文件
4. **注释规范**: 每个文件必须包含文件头注释和方法序号注释

### 14.2 代码审查重点

1. **业务逻辑**: 检查全部相关代码，识别冲突逻辑
2. **冗余代码**: 标记未使用的代码和过度封装
3. **API 对应**: 确保前后端字段名称一致
4. **性能优化**: 批量操作、连接复用、缓存策略

### 14.3 前后端对接

- **前端项目**: `ceramic-electric_furnace-flutter`
- **API 配置**: `lib/api/api.dart` 中的 `baseUrl`
- **字段映射**: 确保 JSON 字段名与 Flutter 模型一致

---

## 15. 依赖清单

```txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
python-snap7==1.3
influxdb-client==1.38.0
pydantic==2.5.3
pydantic-settings==2.1.0
pyyaml==6.0.1
python-dotenv==1.0.0
```
代码文件和我生成的md文档描述都能遵循奥卡姆剃刀原理,不要冗余.
---

**最后更新**: 2026-01-24  
**维护者**: 工控系统开发团队  
**版本**: v1.0
